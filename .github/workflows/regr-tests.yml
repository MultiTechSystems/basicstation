name: regr-tests
on: [push]
jobs:
  run-regr-tests:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        mbedtls-version: ['2.28.8', '3.6.0']
        test-category: ['core', 'tls-cups', 'updn', 'pps']
    name: ${{ matrix.test-category }} (mbedtls ${{ matrix.mbedtls-version }})
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup environment
        run: |
          # python3-jsonschema and python3-jinja2 required for mbedtls 3.x build scripts
          sudo apt-get install -y python3.11 python3-pip virtualenv psmisc git build-essential lcov curl netcat-openbsd python3-jsonschema python3-jinja2
          virtualenv --python python3.11 --system-site-packages pyenv
          . pyenv/bin/activate
          pip3 install setuptools aiohttp websockets
      - name: Execute Tests
        env:
          MBEDTLS_VERSION: ${{ matrix.mbedtls-version }}
        run: |
          # relax some regr test success conditions - related to timing
          . pyenv/bin/activate
          export PPSTHRES=100
          export TX_AIM_GAP='"40ms"'
          cd regr-tests && ./run-tests-${{ matrix.test-category }} --nohw --verbose --ghactions
      - name: Archive logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-${{ matrix.test-category }}-mbedtls-${{ matrix.mbedtls-version }}
          path: regr-tests/t.log/**/*.log

  # Aggregate coverage reports after all tests complete
  coverage-report:
    runs-on: ubuntu-22.04
    needs: run-regr-tests
    if: always()
    name: Coverage Report
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup environment
        run: |
          sudo apt-get install -y python3.11 python3-pip virtualenv psmisc git build-essential lcov curl netcat-openbsd python3-jsonschema python3-jinja2
          virtualenv --python python3.11 --system-site-packages pyenv
          . pyenv/bin/activate
          pip3 install setuptools aiohttp websockets
      - name: Generate Coverage Report
        env:
          MBEDTLS_VERSION: '3.6.0'
        run: |
          . pyenv/bin/activate
          export PPSTHRES=100
          export TX_AIM_GAP='"40ms"'
          # Run all tests to generate coverage data
          make -C regr-tests ci s2core.info || true
      - name: Archive Coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: regr-tests/s2core-html/**

